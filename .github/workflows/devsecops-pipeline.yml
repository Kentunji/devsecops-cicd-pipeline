# DevSecOps CI/CD Pipeline - Stages 1, 2 & 3
# 
# Stage 1: Build & Test
#   - Automated build and test validation
#   - Fails pipeline if tests fail
#
# Stage 2: Secrets Scanning
#   - Detects hardcoded credentials using Gitleaks
#   - Fails pipeline when secrets are detected
#
# Stage 3: SAST (Static Application Security Testing)
#   - Analyzes source code for vulnerabilities using Semgrep
#   - FAILS pipeline on critical/high severity issues
#   - Generates security reports as artifacts

name: DevSecOps Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  # =========================================================================
  # STAGE 1: Build & Test
  # =========================================================================
  build-and-test:
    name: "Stage 1: Build and Test"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build --if-present

      - name: Run test suite
        run: npm test

      - name: Archive build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            build/
            dist/
          retention-days: 5

  # =========================================================================
  # STAGE 2: Secrets Scanning
  # =========================================================================
  secrets-scan:
    name: "Stage 2: Secrets Scanning"
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks secret scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Upload Gitleaks scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 30

  # =========================================================================
  # STAGE 3: SAST (Static Application Security Testing)
  # =========================================================================
  sast-scan:
    name: "Stage 3: SAST"
    runs-on: ubuntu-latest
    needs: build-and-test
    container:
      image: semgrep/semgrep
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep scan (JSON output)
        run: |
          semgrep scan \
            --config auto \
            --config p/javascript \
            --config p/typescript \
            --config p/nodejs \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --json \
            --output semgrep-results.json \
            . || true

      - name: Run Semgrep scan (readable report)
        if: always()
        run: |
          semgrep scan \
            --config auto \
            --config p/javascript \
            --config p/typescript \
            --config p/nodejs \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --text \
            --output semgrep-results.txt \
            . || true

      - name: Generate SARIF report
        if: always()
        run: |
          semgrep scan \
            --config auto \
            --config p/javascript \
            --config p/typescript \
            --config p/nodejs \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --sarif \
            --output semgrep-results.sarif \
            . || true

      - name: Quality Gate - Check for Critical/High findings
        run: |
          if [ -f semgrep-results.json ]; then
            # Count ERROR (critical/high) severity findings
            CRITICAL_HIGH=$(cat semgrep-results.json | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          results = data.get('results', [])
          critical_high = [r for r in results if r.get('extra', {}).get('severity', '') == 'ERROR']
          print(len(critical_high))
          " 2>/dev/null || echo "0")
            
            # Count WARNING (medium) severity findings
            WARNINGS=$(cat semgrep-results.json | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          results = data.get('results', [])
          warnings = [r for r in results if r.get('extra', {}).get('severity', '') == 'WARNING']
          print(len(warnings))
          " 2>/dev/null || echo "0")
            
            echo "=========================================="
            echo "SAST Quality Gate Results"
            echo "=========================================="
            echo "Critical/High (ERROR): $CRITICAL_HIGH"
            echo "Medium (WARNING): $WARNINGS"
            echo "=========================================="
            
            if [ "$CRITICAL_HIGH" -gt 0 ]; then
              echo "::error::❌ SAST Quality Gate FAILED!"
              echo "::error::Found $CRITICAL_HIGH critical/high severity issues"
              echo "::error::Review semgrep-results.txt for details"
              exit 1
            else
              echo "✅ SAST Quality Gate PASSED"
              echo "No critical/high severity issues found"
            fi
          else
            echo "::error::Semgrep results file not found"
            exit 1
          fi

      - name: Upload SAST reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-semgrep-report
          path: |
            semgrep-results.json
            semgrep-results.txt
            semgrep-results.sarif
          retention-days: 30
